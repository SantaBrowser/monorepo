<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Redirect</title>
</head>

<body>
    Loading...
    <script>
        const url = new URL(location.href);
        const code = url.searchParams.get('code')
        const iss = url.searchParams.get('iss')
        const state = JSON.parse(window.atob(url.searchParams.get('state').split('%')[0]));

        const tokenRequestHandler = (user) => {
            const hashParams = {
                accessToken: user.access_token,
                idToken: user.id_token,
                expiresAt: Date.now() + (user.expires_in * 1000),
                tokenType: user.token_type,
                scope: user.scope,
            }
            const queryParams = {};
            for (var key of url.searchParams.keys()) {
                queryParams[key] = url.searchParams.get(key);
            }

            let error = "";
            try {
                if (Object.keys(hashParams).length > 0 && hashParams.state) {
                    instanceParams = JSON.parse(window.atob(decodeURIComponent(decodeURIComponent(hashParams.state)))) || {};
                    if (hashParams.error) error = hashParams.error;
                } else if (Object.keys(queryParams).length > 0 && queryParams.state) {
                    instanceParams = JSON.parse(window.atob(decodeURIComponent(decodeURIComponent(queryParams.state)))) || {};
                    if (queryParams.error) error = queryParams.error;
                }
            } catch (e) {
                console.error(e);
            }

            window.opener.postMessage(
                {
                    channel: "redirect_channel_" + instanceParams.instanceId,
                    data: {instanceParams, hashParams, queryParams},
                    error: error,
                },
                window.location.origin
            );
        }

        fetch(iss + '/token', {
            method: 'post',
            mode: 'cors',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                grant_type: 'authorization_code',
                redirect_uri: window.location.origin + window.location.pathname,
                code,
                client_id: state.clientId,
                client_secret: state.clientSecret,
            })
        })
            .then(response => response.json())
            .then(tokenRequestHandler)
            .catch(console.error)


    </script>
</body>

</html>